<%
    SearchSECO.methods = SearchSECO.methods.sort((a, b) => { return b.matches.length - a.matches.length; });
    SearchSECO.matchCount = 0;
    SearchSECO.vulnerableMethodCount = 0;
    SearchSECO.vulnerableMatchCount = 0;
    for (let i = 0; i < SearchSECO.methods.length; i++) {
        let method = SearchSECO.methods[i];

        SearchSECO.matchCount += method.matches.length;

        for (const match of method.matches) {
            if (match.vuln.code !== -1) {
                SearchSECO.vulnerableMatchCount++;

                if (method.vulnerable !== true) {
                    method.vulnerable = true;
                    SearchSECO.vulnerableMethodCount++;
                }
            }
        }
    }

    SearchSECO.projects = {};
    SearchSECO.vulnerableProjectCount = 0;
    for (const method of SearchSECO.methods) {
        for (const match of method.matches) {
            let project = match.data.project;

            let matchInfo = { yourMethod: method, match: match };
            if (SearchSECO.projects[project] === undefined) {
                SearchSECO.projects[project] = { name: project, matches: [matchInfo] };
            } else {
                SearchSECO.projects[project].matches.push(matchInfo);
            }

            if (match.vuln.code !== -1) {
                SearchSECO.projects[project].vulnerable = true;
                SearchSECO.vulnerableProjectCount++;
            }
        }
    }
    SearchSECO.projects = Object.values(SearchSECO.projects);
    for (const project of SearchSECO.projects) {
        project.matches.sort((a, b) => { return b.yourMethod.matches.length - a.yourMethod.matches.length; });
    }
    SearchSECO.projects = SearchSECO.projects.sort((a, b) => { return b.matches.length - a.matches.length; });
%>

<div class="SearchSECO Hidden">
    <h1>Total matches: <%- SearchSECO.matchCount %></h1>
    <div class="SearchSECO__Nav">
        <button class="SearchSECO__Nav__Button--Active" id="SearchSECO__MethodsButton" onClick="SearchSECOShowMethods()" data-linked-class="SearchSECO__Methods"><i class="fa-solid fa-file-code"></i> Methods</button>
        <button id="SearchSECO__ProjectsButton" onClick="SearchSECOShowProjects()" data-linked-class="SearchSECO__Projects"><i class="fa-solid fa-box-archive"></i> Projects</button>
        <div style="display: flex; flex-direction: row; align-items: center">
            <input type="checkbox" id="SearchSECO_ToggleShowVulnerable" onclick="SearchSECOToggleShowVulnerabilities()"<% if (SearchSECO.vulnerableMethodCount === 0) { %> disabled<% } %>>
            <label for="SearchSECO_ToggleShowVulnerable">Show vulnerabilities only<br><%- SearchSECO.vulnerableMatchCount %> match<% if (SearchSECO.vulnerableMatchCount !== 1) { %>es<% } %> / <%- SearchSECO.vulnerableMethodCount %> method<% if (SearchSECO.vulnerableMethodCount !== 1) { %>s<% } %> / <%- SearchSECO.vulnerableProjectCount %> project<% if (SearchSECO.vulnerableProjectCount !== 1) { %>s<% } %></label>
        </div>
    </div>
    <div class="SearchSECO__List SearchSECO__MethodList">
        <p><%- SearchSECO.methods.length %> of your methods found matches</p>

        <% for (const method of SearchSECO.methods) { %>
        <%- include('SearchSECO-method', { "method": method }); %>
        <% } %>
    </div>
    <div class="SearchSECO__List SearchSECO__ProjectList" hidden>
        <p>Your methods found matches with <%- SearchSECO.projects.length %> project<% if (SearchSECO.projects.length !== 1) { %>s<% } %></p>

        <% for (const project of SearchSECO.projects) { %>
        <%- include('SearchSECO-project', { "project": project }); %>
        <% } %>
    </div>
</div>

<style>
    .SearchSECO {
        width: 100%;
        height: 70%;
        -webkit-mask-image: linear-gradient( to bottom, black 90%, transparent 100% );
        mask-image: linear-gradient(to bottom, black 90%, transparent 100%);
        overflow: hidden scroll;
        word-break: break-word;
        padding: 16px;
    }
    .SearchSECO--HideNonVulnerable .SearchSECO--NotVulnerable {
        display: none;
    }

    .SearchSECO__Nav {
        display: flex;
        flex-direction: row;
        align-items: center;
        margin-left: 1%;
    }
    .SearchSECO__Nav > * {
        margin-right: 0.6vw;
        font-size: 1vw;
    }
    .SearchSECO__Nav button {
        padding: 0.5vw;
        border: 1px solid #779C7E;
        background: transparent;
        border-radius: 8px;
        color: #D9F8DF;
        cursor: pointer;
        transition: all 300ms ease;
    }
    .SearchSECO__Nav button.SearchSECO__Nav__Button--Active {
        background: #D9F8DF;
        color: #0C281E;
        border: 1px solid #D9F8DF;

    }
    .SearchSECO__Nav input {
        width: 1.15vw;
        height: 1.15vw;
    }
    .SearchSECO__Nav label {
        color: #D9F8DF;
        font-size: 0.8vw;
        margin-left: 0.4vw;
    }

    .SearchSECO__List {
        width: 98%;
        margin: 1%;
    }
    .SearchSECO__List h1 {
        font-size: 1.7vw;
    }

    .SearchSECO__ListObject__Header {
        color: #D9F8DF;
        font-size: 0.8rem;
        /* background-color: #47715A; */
        border: 1px solid #779C7E;
        border-radius: 7px;
        padding: 8px;
        padding-left: calc(1.8vw + 5px);
        margin-top: 5px;
        margin-bottom: 5px;
    }
    .SearchSECO__ListObject__Header__Start {
        width: 100%;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    .SearchSECO__ListObject__Header h1 {
        font-size: 1.1rem;
    }
    .SearchSECO__ListObject__Header p, .SearchSECO__ListObject__Header h1 {
        margin: 0;
    }
    .SearchSECO__ListObject__Header h1 i {
        font-size: 1.5vw;
        width: 1.8vw;
        margin-left: -1.8vw;
        text-align: center;
    }
    .SearchSECO__ListObject__Header h1 i:hover {
        color: #b8d7cc;
        cursor: pointer;
    }
    .SearchSECO__ListObject__Header span {
        margin-right: 1.5vw;
        color: #fcec69;
    }
    .SearchSECO__ListObject__MatchList {
        width: 95%;
        margin-left: 5%;
    }

    .SearchSECO__Match {
        color: #D9F8DF;
        font-size: 0.7rem;
        /* background-color: #47715A; */
        border: 1px solid #779C7E;
        border-radius: 7px;
        padding: 12px;
        margin-top: 5px;
        margin-bottom: 5px;
    }
    .SearchSECO__Match span {
        /* color: yellow; */
        color: #fcec69;
    }
    .SearchSECO__Match__Header {
        width: 100%;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    .SearchSECO__Match__Header h2 {
        font-size: 1rem;
        margin: 0;
    }
    .SearchSECO__Match h3 {
        font-size: 0.9rem;
        margin: 0;
    }
    .SearchSECO__Match a {
        color: #D9F8DF; 
    }
</style>

<script>
    const SearchSECO = document.querySelector(".SearchSECO");
    const SearchSECOMethodsButton = document.getElementById("SearchSECO__MethodsButton");
    const SearchSECOProjectsButton = document.getElementById("SearchSECO__ProjectsButton");
    const SearchSECOMethodList = document.querySelector(".SearchSECO__MethodList");
    const SearchSECOProjectList = document.querySelector(".SearchSECO__ProjectList");

    function SearchSECOToggleShowVulnerabilities() {
        SearchSECO.classList.toggle("SearchSECO--HideNonVulnerable");
    }

    function SearchSECOShowMethods() {
        SearchSECOProjectList.hidden = true;
        SearchSECOMethodList.hidden = false;
        
        SearchSECOProjectsButton.classList.remove("SearchSECO__Nav__Button--Active");
        SearchSECOMethodsButton.classList.add("SearchSECO__Nav__Button--Active");
    }

    function SearchSECOShowProjects() {
        SearchSECOMethodList.hidden = true;
        SearchSECOProjectList.hidden = false;
        
        SearchSECOMethodsButton.classList.remove("SearchSECO__Nav__Button--Active");
        SearchSECOProjectsButton.classList.add("SearchSECO__Nav__Button--Active");
    }

    function SearchSECOClickArrow(event) {
        event.target.classList.toggle("fa-angle-right");
        event.target.classList.toggle("fa-angle-down");

        let elem = event.target;
        while (elem = elem.parentNode) {
            if (elem.classList?.contains("SearchSECO__ArrowOwner")) {
                let target = elem.querySelector(".SearchSECO__ArrowTarget");
                target.hidden = !target.hidden;
                break;
            }
        }
    }
</script>
